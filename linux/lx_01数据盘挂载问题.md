# 概述
前段时间发现自己的服务器满了，突然想起自己买的阿里云服务器时还买了个数据盘呢，自从换成Ubuntu后就一直没有用到这个数据盘，所以今天去研究了一些，做点记录。

查看系统上磁盘占用情况

- 使用如下命令查看磁盘占用情况

```shell
df -h
# 输出

root@xxxxxxxx:/# df -h
Filesystem      Size  Used Avail Use% Mounted on
udev            975M     0  975M   0% /dev
tmpfs           200M  2.8M  197M   2% /run
/dev/vda1        40G  8.9G   29G  24% /
tmpfs           997M     0  997M   0% /dev/shm
tmpfs           5.0M     0  5.0M   0% /run/lock
tmpfs           997M     0  997M   0% /sys/fs/cgroup
tmpfs           200M     0  200M   0% /run/user/0

```


若发现只有一个磁盘/dev/vda1，说明数据盘没有被挂载。

## 查看系统磁盘挂载情况
```shell
fdisk -l
来查看挂载情况
root@zbcn:/# fdisk -l

Disk /dev/vdb: 15 GiB, 16106127360 bytes, 31457280 sectors
Units: sectors of 1 * 512 = 512 bytes
Sector size (logical/physical): 512 bytes / 512 bytes
I/O size (minimum/optimal): 512 bytes / 512 bytes
Disklabel type: dos
Disk identifier: 0xb9d01f0b
```


如果发现上面输出结果中没有类似 Disk /dev/vdb:的部分，说明你没有数据盘，所以下面的挂载操作就没有意义了，转身离开即可，当然留个赞再走也是极好的。

## 挂载数据盘

- 对数据盘分区
  ```shell
  fdisk  /dev/vdb
  ```

  - 其中/dev/vdb是你的数据盘，键入上面的命令后会出现分区命令，我们依次输入n 、p、1、回车，回车、wq 即可。

上面那些输入都是对分区命令参数的选择，你也可以按照需要选择其他参数 。

再次输入`fdisk -`l查看，如出现类似如下的输出，说明已经分区成功

```
Device     Boot Start      End  Sectors Size Id Type
/dev/vdb1        2048 31457279 31455232  15G 83 Linux
```


## 格式化分区
```shell
mkfs.ext4  /dev/vdb1
```

## 将磁盘挂载到系统中
选择一个你要挂载磁盘的地方，此处我在/mnt中建立一个ss007的文件夹。

```shell
cd /mnt
mkdir ss007
# 使用
mount  /dev/vdb1  /mnt/ss007
# 将磁盘/dev/vdb1挂载到/mnt/ss007下

```

## 配置服务器重启自动挂载
完成以上的步骤后就可以使用数据盘了。但是仍然存在一个问题：当服务器重启后磁盘的挂载就失效了，你需要再次挂载，所以我们如何设置开机自动挂载呢？那就需要修改/etc/fstab文件。

使用`blkid`命令来查询磁盘的UUID

```shell
root@zbcn:/# blkid /dev/vdb1
/dev/vdb1: UUID="9fe20997-*****" TYPE="ext4" PARTUUID="b9d01f0b-01"
```


修改/etc/fstab文件

```shell
# 命令
root@iZ28k2ghmchZ:/# vim /etc/fstab
# 内容
//<file system>     <mount point>  <type>  <options>       <dump>  <pass>
UUID=9fe20997-*****  /mnt/ss007     ext4    defaults        0           2
```

<dump>: dump是否要记录。1: 记录；0: 不记录
<pass>: 开机时检查的顺序。0：不检查；1：boot系统文件就为；2：其他文件系统都为2；



# 数据盘重新挂载

```shell
umount /dev/vdb1
```





# mysql 数据迁移数据盘

## 查看mysql 数据存储位置方法

```sql
show global variables like "%datadir%";
# 输出
datadir,/usr/local/mysql/data/

```

## 停服务

```shell
service mysqld stop
```

### 执行命令报错解决方案

```shell
find / -name mysql.server
# out /usr/local/mysql/support-files/mysql.server
# 重新停止：
/usr/local/mysql/support-files/mysql.server stop

```



## 迁移

```shell
# 将文件拷贝到新的目录下
cp -a -r /var/lib/mysql/data /mnt/betaData/mysqlData/data
-a -r 为将原始文件夹的权限也复制过去

# 改配置
# 查找配置文件
whereis my.cnf

# 修改配置文件
vim /etc/my.cnf
#若这里面写的是文件配置放在了另外一个文件夹中，则需要注意到这个文件夹下面找mysql-server.cnf进行配置

# 将原始的注释掉，然后新增我们指定目录下的文件
#datadir=/var/lib/mysql
datadir=/mnt/betaData/mysqlData/mysql

#socket=/var/lib/mysql/mysql.sock
socket=/mnt/betaData/mysqlData/mysql.sock

# 新增配置
[client]
socket = /home/database/mysql/mysql.sock
[mysql]
socket = /home/database/mysql/mysql.sock

# 给目录赋予新权限
chown -R mysql:mysql /home/database/mysql/
# 再重启
service mysqld start
# 或者
/usr/local/mysql/support-files/mysql.server stop

```

##  脚本运行方案

- 脚本1

```shell
# 停止服务，创建文件夹database,复制mysql文件到home下的database,修改权限
service mysqld stop && mkdir /home/database && cp -a -r /var/lib/mysql /home/database/ && chown -R mysql:mysql /home/database/mysql/ 
```

- 脚本2

```shell
# 停止服务,将原始 /etc/my.cnf.d/mysql-server.cnf进行备份（若是/etc/my.cnf请自行修改）,将我们编辑好的文件复制到这里,启动mysql服务
service mysqld stop && cp /etc/my.cnf.d/mysql-server.cnf  /etc/my.cnf.d/mysql-server.cnf.back && cp mysql-server.cnf /etc/my.cnf.d/mysql-server.cnf && service mysqld start
```



### 配置文件 mysql-server.cnf

修改目录位置

```shell
#
# This group are read by MySQL server.
# Use it for options that only the server (but not clients) should see
#
# For advice on how to change settings please see
# http://dev.mysql.com/doc/refman/en/server-configuration-defaults.html
 
# Settings user and group are ignored when systemd is used.
# If you need to run mysqld under a different user or group,
# customize your systemd unit file for mysqld according to the
# instructions in http://fedoraproject.org/wiki/Systemd
 
 
[mysqld]
#datadir=/var/lib/mysql
datadir=/home/database/mysql
#socket=/var/lib/mysql/mysql.sock
socket=/home/database/mysql/mysql.sock
log-error=/var/log/mysql/mysqld.log
pid-file=/run/mysqld/mysqld.pid
 
 
[client]
socket = /home/database/mysql/mysql.sock
[mysql]
socket = /home/database/mysql/mysql.sock
```

### 将文件复制到服务器上

```shell
# 赋予权限
chmod -R 777 /home/shell

```

### 执行

```shell
cd /home/shell
./1.sh
./2.sh
```

如果没有报错，则完成迁移